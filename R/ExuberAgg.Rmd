---
title: "Exuber Aggergate"
author: "Contentio d.o.o."
date: "`r format(Sys.time(), '%d-%m-%Y')`"
# output: word_document
output:
  prettydoc::html_pretty:
    theme: tactile
    highlight: github
params:
  lean_path: 'C:/Users/Mislav/Documents/GitHub/lean_test/ExuberLocal/optimizations/2021-04-22_09-26-38/31ba6169-b31a-4da8-a92d-d6df29eea480'
  algortihm_name: ExuberAlgorithm
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(warning=FALSE, echo=FALSE, message=FALSE)

library(tidyr)
library(jsonlite)
library(kableExtra)
library(purrr)
library(data.table)
library(ggplot2)
library(PerformanceAnalytics)
library(DT)
```

```{r include=FALSE}
# read json file with results
test <- 'C:/Users/Mislav/Documents/GitHub/lean_test/ExuberLocal/optimizations/2021-04-22_09-26-38/31ba6169-b31a-4da8-a92d-d6df29eea480'
results_json_path <- file.path(test, paste0(gsub(".*/", "", test), ".json")) # TEST

results_json_path <- file.path(params$lean_path, paste0(gsub(".*/", "", params$lean_path), ".json"))
result <- read_json(results_json_path)
names(result)
```

# OPIS STRATEGIJE

Za razumijevanje ove strategije potrebno je prvo pročitati opis Exuber strategije. U Exuber strategiji je objašnjeno kako se pomoću statističkog testa može testirati hipoteza o postojanju balona na financijskim tržištima. Posebnost ove strategije je što spomenuti test provodi na svima dionicama sastavnicama SP500. Dakle, umjesto testiranja hipoteze o postojanju balona na temelju jedne serije (cijene SPY-a), koristi se kompletan skup dionica sastavnica SPY-a.

Nakon što se izračunaju testovi o eksplozivnosti serije (skraćeno nazvane adf, sadf, gsadf, bsadf) na određenom prozoru potrebno je na neki način agregirati sve izračunate vrijednosti. Metodom pokušaja i pogreške je utvrđeno da najbolji signal daje standardna devijacija varijable radf, pri čemu je rad izračunat kao suma svih spomenutih vrijednosti (adf, sadf, gsadf, bsasdf). Kada vrijednosti standardne devijacije radfa prijeđe određenu razinu, prodajemo dionicu SPY-a.


# OPIS ALGORITMA 

Algoritam se sastoji od sljedećih koraka

1. Univerzum - strategija koristi sve dionice sastavnice SPY-a.
2. Na *rolling windowu* izračunavamo adf, sadf , gsadf i bsadf vrijendosti. Duljina rolling windowa iznosi 600.
3. Kreiramo novu varijablu radf koja je jednaka adf + sadf + gsadf + bsadf.
4. Izračunavamo standardnu devijaciju od radf (std_radf).
5. Izračunavamo SMA za vrijednost iz 4 duljine 8.
6. Uspoređujemo std_radf vrijednost iz 5. sa određenim thresholdom (3 u našem slučaju]).
7. Prodajemo dionicu kada vrijednost indikatora prijeđe kritičnu vrijednost (3). Ponovno kupujemo dionicu, kao vrijednost opet padne ispod 3.


# PRIKAZ NAJBOLJE STRATEGIJE

Radi jednostavnosti, prikazujemo rezultate najbolje strategije. Analiza unutar R okruženja (izvan robusnog Quantconnect backtesting sustava) pokazala je da je najbolja strategije ona koja koristi standardnu devijaciju radf varijable kao ključni identifikator, a granična vrijednost iznosi 3.5. Rezultati su prikazani u donjem dokumentu.


<iframe width="100%" height="1000" name="iframe" src="C:/Users/Mislav/Documents/GitHub/alphar/backtests/ExuberAggregate/exuber_aggregate_threshold3_SMA8.pdf"></iframe>

Izvještaj možete preuzeti klikom na link: 

```{r echo=FALSE}
xfun::embed_file('C:/Users/Mislav/Documents/GitHub/alphar/backtests/ExuberAggregate/exuber_aggregate_threshold3_SMA8.pdf')
```

# APPENDIX

```{r}
# statistics
algo_stats <- as.data.frame(list(result$Statistics)) %>% 
  pivot_longer(., cols = everything())
  
rows <- seq_len(nrow(algo_stats) %/% 2)
kable(list(algo_stats[rows,1:2],
           algo_stats[-rows, 1:2]),
      col.names = NULL) %>% 
  kable_styling(full_width = FALSE) %>% 
  kable_material(c("striped", "hover"))
```

```{r, out.width='100%'}
# Equity curve plot
benchmark <- rbindlist(result$Charts$Benchmark$Series$Benchmark$Values)
benchmark <- benchmark[y > 0]
benchmark[, Date := as.POSIXct(x, origin="1970-01-01")]
benchmark[, prices := y]
benchmark[, Benchmrk := (prices / shift(prices)) - 1]
benchmark[, `:=`(x = NULL, y = NULL, prices = NULL)]

strategy <- rbindlist(result$Charts$`Strategy Equity`$Series$`Daily Performance`$Values)
strategy[, Date := as.POSIXct(x, origin="1970-01-01")]
strategy[, Strategy := y / 100]
strategy[, `:=`(x = NULL, y = NULL)]

equity_curve <- strategy[benchmark, on = 'Date']
equity_curve <- na.omit(equity_curve)

charts.PerformanceSummary(equity_curve, plot.engine = 'plotly')

```

```{r}
returns <- copy(equity_curve)
returns[, `:=`(StrategyCumulative = cumprod(1 + Strategy),
               BenchmarkCumulative = cumprod(1 + Benchmrk))]
datatable(returns,
          rownames = FALSE,
          escape = FALSE,
          extensions = 'Buttons',
          options = list(dom = 'Blfrtip',
                         buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                         lengthMenu = list(c(10,25,50,-1),
                                           c(10,25,50,"All"))))

```
